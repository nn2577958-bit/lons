<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const ADMIN_EMAIL = "ê´€ë¦¬ìžì´ë©”ì¼@gmail.com";

const adminStatus = document.getElementById("admin-status");
const noticeList = document.getElementById("notice-list");
const kakaoBtn = document.getElementById("kakao-btn");
const discordBtn = document.getElementById("discord-btn");
const logoutBtn = document.getElementById("logout-btn");
const modal = document.getElementById("pc-modal");

const notices=[
  {title:"ê³µì§€ ì‚¬í•­",content:"í•­ìƒ ëª¨ë‹ˆí„°ë§ ì¤‘ì´ë©° ëª¨ë“  íŒŒì¼ì€ ë°ì´í„° ë² ì´ìŠ¤ì— ê¸°ë¡ ë©ë‹ˆë‹¤.",createdAt:"2026-02-12 13:00~13:10"},
  {title:"ì‹ ê·œ ë½‘ê¸° ì´ë²¤íŠ¸ ì‹œìž‘!",content:"ë‹¹ì²¨ë˜ì‹  ë¶„ë“¤ì€ ìš”ì²­ ì£¼ì‹œë©´ ì§€ê¸‰ ì²˜ë¦¬ë©ë‹ˆë‹¤.",createdAt:"2026-02-16 14:00"},
  {title:"ì—…ë°ì´íŠ¸ ì™„ë£Œ",content:"PAL 0.7.2 ìµœì‹  íŒ¨ì¹˜ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.",createdAt:"2026-02-16 14:30"},
  {title:"SV ì˜¤í”ˆ ë‚ ì§œ",content:"2026 01.12",createdAt:"2026-01-12 01:00"},
  {title:"ì§€ì›ê¸ˆ ì•ˆë‚´",content:"ëª¨ë“  ì§€ì›ê¸ˆì€ ìš´ì˜ë¹„ì— ì“°ì´ê³  ìžˆìŠµë‹ˆë‹¤,",createdAt:"2026-02-16 14:30"},
  {title:"ì„œë²„ ì ‘ì† ìƒí™©",content:"1SV / 2SV ëª¨ë‘ ì •ìƒ ìž‘ë™ ì¤‘ìž…ë‹ˆë‹¤.",createdAt:"2026-02-16 00:00"},
  {title:"ì„œë²„ ì˜¤í”ˆ ì•ˆë‚´",content:"í•˜ë“œì½”ì–´ 02 / 20 å¤§ ì˜¤í”ˆ ë§Žì´ ì‚¬ëž‘ í•´ì£¼ì„¸ìš”!",createdAt:"2026-02-20 12:00"}
];

onAuthStateChanged(auth, async(user) => {
  if(!user){ window.location.href="index.html"; return; }

  // Firestore ê´€ë¦¬ìž ìƒíƒœ ë¬¸ì„œ ì°¸ì¡°
  const adminRef = doc(db, "adminStatus/current");

  // ë¡œê·¸ì¸ ì‹œ ê´€ë¦¬ìžë©´ ì˜¨ë¼ì¸ í‘œì‹œ
  if(user.email === ADMIN_EMAIL){
    await setDoc(adminRef, { online: true, lastLogin: Date.now() });
  }

  // ì‹¤ì‹œê°„ ê´€ë¦¬ìž ìƒíƒœ ê°ì‹œ
  onSnapshot(adminRef, (docSnap) => {
    const data = docSnap.data();
    if(data?.online){
      adminStatus.innerHTML = "ðŸŸ¢ ê´€ë¦¬ìž ì˜¨ë¼ì¸";
      adminStatus.style.background = "#28a745";
    } else {
      adminStatus.innerHTML = "ðŸ”´ ê´€ë¦¬ìž ì˜¤í”„ë¼ì¸";
      adminStatus.style.background = "#dc3545";
    }
  });

  // ê³µì§€ì‚¬í•­ ë Œë”ë§
  noticeList.innerHTML = "";
  notices.forEach(data=>{
    const div = document.createElement("div");
    div.className = "notice-item";
    div.innerHTML = `
      <strong>${data.title}</strong>
      <small>${data.createdAt}</small>
      <div>${data.content}</div>
    `;
    noticeList.appendChild(div);
  });
});

// ë¡œê·¸ì•„ì›ƒ ì‹œ ê´€ë¦¬ìž ìƒíƒœ ì˜¤í”„ë¼ì¸ ì²˜ë¦¬
logoutBtn.onclick = async() => {
  const user = auth.currentUser;
  if(user?.email === ADMIN_EMAIL){
    const adminRef = doc(db, "adminStatus/current");
    await setDoc(adminRef, { online: false, lastLogout: Date.now() });
  }
  await signOut(auth);
  window.location.href="index.html";
};

// Discord ë²„íŠ¼
discordBtn.onclick = ()=> window.open("https://discord.gg/tnMXbQ65Hk","_blank");

// ì¹´ì¹´ì˜¤íŽ˜ì´ ë²„íŠ¼
kakaoBtn.onclick = ()=>{
  const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if(isMobile){
    window.location.href="https://qr.kakaopay.com/FRydbZ6Gr";
  } else {
    modal.style.display="flex";
  }
};

// ëª¨ë‹¬ ë‹«ê¸°
window.closeModal = ()=> modal.style.display="none";

</script>
