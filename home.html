<!-- ê³µì§€ì‚¬í•­ ë¶€ë¶„ -->
<div class="user-box">
  <h3>ğŸ“¢ ê³µì§€ì‚¬í•­</h3>
  <div id="notice-list" class="notice-container">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <button id="load-more-btn" style="display:none;">ë”ë³´ê¸°</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const noticeList = document.getElementById("notice-list");
const loadMoreBtn = document.getElementById("load-more-btn");
let notices = [], currentIndex = 0;
const PAGE_SIZE = 5;

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }

  if (!user.emailVerified) {
    noticeList.textContent = "ì´ë©”ì¼ ì¸ì¦ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.";
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    const isMember = userDoc.exists() && userDoc.data()?.isMember;
    if (!isMember) { noticeList.textContent = "ë””ìŠ¤ì½”ë“œ ì„œë²„ ê°€ì… í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."; return; }

    const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    const querySnapshot = await getDocs(postsQuery);
    notices = querySnapshot.docs.map(d => ({ id:d.id, ...d.data() }));
    noticeList.innerHTML = "";
    currentIndex = 0;
    loadNextPage();
  } catch (err) {
    console.error(err);
    noticeList.textContent = "ê³µì§€ì‚¬í•­ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  }
});

function loadNextPage() {
  const next = notices.slice(currentIndex, currentIndex + PAGE_SIZE);
  next.forEach(data => {
    const div = document.createElement("div");
    div.className = "notice";

    const titleEl = document.createElement("strong");
    titleEl.textContent = data.title || "ì œëª© ì—†ìŒ";

    const dateEl = document.createElement("small");
    if(data.createdAt?.toDate) dateEl.textContent = new Date(data.createdAt.toDate()).toLocaleString();

    const contentEl = document.createElement("div");
    contentEl.textContent = data.content || "";

    div.append(titleEl, dateEl, contentEl);
    noticeList.appendChild(div);
  });

  currentIndex += PAGE_SIZE;
  loadMoreBtn.style.display = currentIndex < notices.length ? "block" : "none";
}

loadMoreBtn.addEventListener("click", loadNextPage);
</script>
